<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Construction QA Tracker (Internal)</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#12131a; --muted:#a7adbb; --text:#f3f5ff;
      --line:#23263a; --ok:#1f8f4a; --warn:#d4a11e; --bad:#d14343; --blue:#2f76ff;
      --chip:#1b1e2a;
      --shadow: 0 12px 32px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 30% -10%, #1b1f3a, transparent 60%),
                  radial-gradient(900px 700px at 90% 10%, #152b2a, transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:18px 16px;
      border-bottom:1px solid var(--line);
      position:sticky; top:0; background:rgba(11,12,16,.85); backdrop-filter: blur(10px);
      z-index:10;
    }
    .wrap{max-width:1200px; margin:0 auto;}
    .topbar{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    h1{font-size:18px; margin:0; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:12px; margin-top:4px}
    .btn{
      border:1px solid var(--line);
      background:linear-gradient(180deg, #1a1d2a, #12131a);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.25);
      font-weight:600;
      font-size:13px;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px);}
    .btn:active{transform: translateY(0px);}
    .btn.blue{border-color:rgba(47,118,255,.55); box-shadow:0 10px 22px rgba(47,118,255,.12)}
    .btn.ok{border-color:rgba(31,143,74,.55)}
    .btn.bad{border-color:rgba(209,67,67,.55)}
    .btn.warn{border-color:rgba(212,161,30,.55)}
    .btn.ghost{background:transparent; box-shadow:none}
    .row{display:flex; gap:14px; flex-wrap:wrap; align-items:center}
    .pill{
      background:var(--chip);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
    }

    main{padding:18px 16px 40px}
    .grid{display:grid; grid-template-columns: 340px 1fr; gap:16px;}
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr} }
    .card{
      background:rgba(18,19,26,.9);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card h2{
      font-size:14px; margin:0;
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .card .content{padding:14px}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, select, textarea{
      width:100%;
      background:#0f1119;
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 10px;
      border-radius:12px;
      outline:none;
      font-size:13px;
    }
    textarea{min-height:84px; resize:vertical}
    .list{display:flex; flex-direction:column; gap:10px;}
    .item{
      border:1px solid var(--line);
      background:rgba(15,17,25,.75);
      border-radius:14px;
      padding:12px;
      cursor:pointer;
      transition:.12s ease;
    }
    .item:hover{border-color:#2f3554}
    .item.active{border-color:rgba(47,118,255,.7); box-shadow:0 0 0 2px rgba(47,118,255,.12) inset}
    .item .title{font-weight:700; font-size:13px}
    .item .meta{color:var(--muted); font-size:12px; margin-top:6px; display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      background:var(--chip);
      border:1px solid var(--line);
      padding:5px 8px;
      border-radius:999px;
      font-size:11px;
      color:var(--muted);
    }
    .chip b{color:var(--text); font-size:11px}
    .hr{height:1px; background:var(--line); margin:12px 0}

    .phaseBox{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:rgba(15,17,25,.55);
      margin-bottom:12px;
    }
    .phaseTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    .phaseName{font-weight:800}
    .small{font-size:12px; color:var(--muted)}
    .checks{margin-top:10px; display:flex; flex-direction:column; gap:8px}
    .checkRow{
      display:flex; align-items:center; gap:10px;
      border:1px dashed rgba(35,38,58,.75);
      border-radius:12px; padding:8px 10px;
      background:rgba(15,17,25,.35);
    }
    .checkRow input[type="checkbox"]{width:auto; transform:scale(1.15)}
    .checkRow .txt{flex:1; font-size:13px}
    .twoCol{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width:680px){.twoCol{grid-template-columns:1fr}}
    .rightActions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .mutedNote{color:var(--muted); font-size:12px; line-height:1.35}
    .danger{color:#ff9a9a}
    .tag{display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:rgba(15,17,25,.55); font-size:11px; color:var(--muted)}
    .tag.open{border-color:rgba(209,67,67,.6)}
    .tag.progress{border-color:rgba(212,161,30,.6)}
    .tag.resolved{border-color:rgba(31,143,74,.6)}
    .table{width:100%; border-collapse:collapse; font-size:12px}
    .table th,.table td{border-bottom:1px solid var(--line); padding:8px 6px; vertical-align:top}
    .table th{color:var(--muted); font-weight:700; text-align:left}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>
<header>
  <div class="wrap topbar">
    <div>
      <h1>Construction QA Tracker (Internal)</h1>
      <div class="sub">Editable milestones + signoff roster • Discrepancy reports • Export/Import JSON backup</div>
    </div>
    <div class="row">
      <span class="pill" id="statPill">0 projects</span>
      <button class="btn blue" id="btnExport">Export Backup</button>
      <label class="btn ghost" style="display:inline-flex; align-items:center; gap:10px; cursor:pointer;">
        Import Backup
        <input type="file" id="fileImport" accept="application/json" style="display:none;">
      </label>
      <button class="btn bad" id="btnReset">Reset (wipe local)</button>
    </div>
  </div>
</header>

<main>
  <div class="wrap grid">
    <!-- LEFT: Projects -->
    <section class="card">
      <h2>
        <span>Projects</span>
        <button class="btn ok" id="btnAddProject">+ Add</button>
      </h2>
      <div class="content">
        <div class="twoCol">
          <div>
            <label>Search</label>
            <input id="projectSearch" placeholder="Type a customer / job name..." />
          </div>
          <div>
            <label>Sort</label>
            <select id="projectSort">
              <option value="updated_desc">Most recently updated</option>
              <option value="name_asc">Name A → Z</option>
              <option value="name_desc">Name Z → A</option>
              <option value="created_desc">Newest created</option>
              <option value="created_asc">Oldest created</option>
            </select>
          </div>
        </div>
        <div class="hr"></div>
        <div class="list" id="projectList"></div>
        <div class="hr"></div>
        <div class="mutedNote">
          Tip: Export a backup weekly. Import restores everything (projects + library + discrepancies + roster).
        </div>
      </div>
    </section>

    <!-- RIGHT: Detail -->
    <section class="card">
      <h2>
        <span id="detailTitle">Select a project</span>
        <div class="rightActions">
          <button class="btn warn" id="btnDiscrepancies">Discrepancy Reports</button>
          <button class="btn" id="btnEditLibrary">Edit Library</button>
          <button class="btn" id="btnEditRoster">Edit QA Roster</button>
          <button class="btn bad" id="btnDeleteProject" title="Delete selected project">Delete Project</button>
        </div>
      </h2>
      <div class="content" id="detailPane">
        <div class="mutedNote">
          Add a project on the left to start tracking QA per phase.
        </div>
      </div>
    </section>
  </div>
</main>

<!-- Modal -->
<div id="modal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:50; padding:18px;">
  <div class="card" style="width:min(980px, 100%); max-height:86vh; overflow:auto;">
    <h2>
      <span id="modalTitle">Modal</span>
      <button class="btn ghost" id="btnCloseModal">Close</button>
    </h2>
    <div class="content" id="modalBody"></div>
  </div>
</div>

<script>
/**
 * state = {
 *   roster: { approvers: [ {id, name} ] },
 *   library: { phases: [ {id, name, checks:[{id, text}]} ] },
 *   projects: [ {id, name, createdAt, updatedAt, currentPhaseId, qa:{phaseId:{checkId:true}}, signoff:{phaseId:{approverId,date}}, notes:{phaseId:""}, builder:{name,email}} ],
 *   discrepancies: [ {id, projectId, phaseId, createdAt, updatedAt, title, description, severity, status, assignedTo, dueDate, photoLinks, reportedBy, builderEmailOverride} ]
 * }
 */
const LS_KEY = "construction_qa_tracker_v2";
const uid = () => Math.random().toString(36).slice(2,10) + "_" + Date.now().toString(36);

const defaultLibrary = () => ({
  phases: [
    { id: uid(), name: "Pre Construction", checks: [
      {id: uid(), text: "Contract signed & scope verified"},
      {id: uid(), text: "Engineering/plans approved (if required)"},
      {id: uid(), text: "Equipment list verified (models/options)"},
      {id: uid(), text: "Utility locate complete"},
      {id: uid(), text: "Pre-build meeting complete / notes saved"},
    ]},
    { id: uid(), name: "Excavation", checks: [
      {id: uid(), text: "Layout confirmed (orientation / setbacks)"},
      {id: uid(), text: "Depths verified (laser)"},
      {id: uid(), text: "Steps / shelves located correctly"},
      {id: uid(), text: "Bond beam height confirmed"},
    ]},
    { id: uid(), name: "Shell/Wall Standing", checks: [
      {id: uid(), text: "Walls plumb / square where applicable"},
      {id: uid(), text: "Structural alignment verified"},
      {id: uid(), text: "Penetrations / niches secured"},
    ]},
    { id: uid(), name: "Liner Hang", checks: [
      {id: uid(), text: "Liner inspected (no defects)"},
      {id: uid(), text: "Vacuum set & seams positioned correctly"},
      {id: uid(), text: "Faceplates / gaskets ready & correct"},
    ]},
    { id: uid(), name: "Plumbing Inspection", checks: [
      {id: uid(), text: "Pressure test completed & logged"},
      {id: uid(), text: "Valves labeled / routing verified"},
      {id: uid(), text: "Bonding plan confirmed (as applicable)"},
    ]},
    { id: uid(), name: "Ba
